trigger:
  - none

pool: "Default"

    
variables:
  dockerRegistryServiceConnection: 'DockerHubConnection'
  imageRepository: 'prmd77/backend'
  containerRegistry: 'prmd77'
  tag: '$(Build.BuildId)'
  namespace: 'default'

stages:
- stage: Build
  displayName: Build and Push
  jobs:
  - job: Build
    steps:
    - task: Docker@2
      displayName: Build and Push image
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: '**/Dockerfile'
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)

- stage: Deploy
  displayName: Deploy to VMware K8s
  jobs:
  - job: Deploy
    steps:
    # Deploy manifests using kubectl
    - script: |
        echo "Deploying to On-Prem Kubernetes cluster..."
        kubectl apply -f backend/deployment.yaml -n $(namespace)
        kubectl apply -f backend/service.yaml -n $(namespace)
        kubectl apply -f ingress.yaml -n $(namespace)
        kubectl set image deployment/backend backend=$(containerRegistry)/$(imageRepository):$(tag) -n $(namespace)
        kubectl get pods -n $(namespace)
      displayName: "Deploy App to On-Prem K8s"
