trigger:
  - none

pool: 
  name: "Default"

variables:

  manifestPath: 'fullstuch-web-backend-project/backend'
  dockerRegistryServiceConnection: 'DockerHubConnection'
  imageRepository: 'prmd77/backend'
  tag: '$(Build.BuildId)'
  namespace: 'default'

stages:
- stage: Build
  displayName: Build and Push
  jobs:
  - job: Build
    steps:
    - task: Docker@2
      displayName: Build and Push image
      inputs:
        command: buildAndPush
        repository: $(imageRepository)
        dockerfile: '**/Dockerfile'
        containerRegistry: $(dockerRegistryServiceConnection)
        tags: |
          $(tag)

- stage: Deploy
  displayName: Deploy to VMware K8s
  jobs:
  - job: Deploy
    steps:
    - task: KubernetesManifest@1
      inputs:
        action: 'deploy'
        connectionType: 'kubernetesServiceConnection'
        kubernetesServiceConnection: 'OnPremKubeConnection'
        namespace: 'default'
        manifests: |
          $(Build.SourcesDirectory)/$(manifestPath)/deployment.yaml
          $(Build.SourcesDirectory)/$(manifestPath)/service.yaml
          $(Build.SourcesDirectory)/$(manifestPath)/ingress.yaml
